<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Data with CodeMirror</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #sourceText {
            height: 200px; /* Height for the editable area */
            border: 1px solid #ccc; /* Border for the editor */
            border-radius: 5px; /* Rounded corners */
            margin-bottom: 20px; /* Space below the editor */
            padding: 10px; /* Padding for spacing */
        }
        #itemHtml {
            height: 200px; /* Height for the CodeMirror instance */
            border: 1px solid #ccc; /* Border for the CodeMirror area */
            border-radius: 5px; /* Rounded corners */
            margin-bottom: 20px; /* Space below the CodeMirror */
        }
        .highlight {
            background-color: #e1f5fe; /* Light blue background for HTML tags */
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="dataContainer" style="display: none;">
        <h1>Edit Data</h1>
        <label for="sourceText">Source Text:</label>
        <div id="sourceText" contenteditable="true"></div> <!-- Content editable div -->

        <label for="itemHtml">Item HTML:</label>
        <textarea id="itemHtml"></textarea> <!-- For displaying formatted HTML -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script> <!-- For HTML Mode -->

    <script>
        window.onload = function() {
            // Get the full document content from session storage
            const editContent = sessionStorage.getItem('editContent');

            if (editContent) {
                // Create a temporary DOM element to parse the HTML string
                const parser = new DOMParser();
                const doc = parser.parseFromString(editContent, 'text/html');

                // Extract the JSON data from the script tag with id "data"
                const jsonDataElement = doc.getElementById('data');

                if (jsonDataElement) {
                    try {
                        // Parse the JSON content
                        const jsonData = JSON.parse(jsonDataElement.textContent);

                        // Populate the contenteditable div with the extracted source text
                        document.getElementById('sourceText').innerText = jsonData.source_text || '';

                        // Initialize CodeMirror for the item HTML textarea
                        var editor = CodeMirror.fromTextArea(document.getElementById("itemHtml"), {
                            lineNumbers: true,
                            mode: "text/html", // Set mode to HTML for syntax highlighting
                            theme: "default",
                            autoCloseTags: true,
                            matchBrackets: true,
                            lineWrapping: true,
                            indentUnit: 4, // Number of spaces for indentation
                            tabSize: 4, // Number of spaces a tab is equivalent to
                            smartIndent: true, // Enable smart indentation
                        });

                        // Set the initial value for the CodeMirror instance
                        editor.setValue(jsonData['item-html'] || '');

                        // Display the container with the loaded data
                        document.getElementById('dataContainer').style.display = 'block';
                    } catch (error) {
                        console.error('Error parsing JSON from the script tag:', error);
                    }
                } else {
                    console.warn('No JSON data found in the script tag with id "data".');
                }
            } else {
                console.warn('No content found in session storage.');
            }
        };
    </script>
</body>
</html>